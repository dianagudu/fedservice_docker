version: '3.9'

services:
  setup:
    image: ddgu/fedservice
    command: "/app/setup.sh"
    user: ${UID}:${GID}
    volumes:
      - ./conf:/conf
    profiles: ['setup']
  display:
    image: ddgu/fedservice
    entrypoint:
      - "python3"
      - "/app/display_entity.py"
    networks:
      - traefik
    profiles: ['cmd']
  lu:
    image: ddgu/fedservice
    init: true
    hostname: lu.fed2
    networks:
      - default
      - traefik
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.fedservice-lu-http.rule=Host("lu.fedservice.lh")
      - traefik.http.routers.fedservice-lu-http.entrypoints=http
      - traefik.http.routers.fedservice-lu-http.middlewares=https-redirect
      - traefik.http.routers.fedservice-lu-https.rule=Host("lu.fedservice.lh")
      - traefik.http.routers.fedservice-lu-https.entrypoints=https
      - traefik.http.routers.fedservice-lu-https.tls=true
      - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.https-redirect.redirectscheme.permanent=true
      - traefik.http.services.fedservice-lu.loadbalancer.server.port=11833
    environment:
      - ENTITY_TYPE=intermediate
      - ENTITY_NAME=LU
    ports:
      - 6001:11833
    volumes:
      - ./mkcertRootCA.crt:/usr/local/share/ca-certificates/mkcertRootCA.crt:ro
      - ./conf/intermediate/lu:/conf:ro
  umu:
    image: ddgu/fedservice
    init: true
    hostname: umu.fed2
    networks:
      - default
      - traefik
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.fedservice-umu-http.rule=Host("umu.fedservice.lh")
      - traefik.http.routers.fedservice-umu-http.entrypoints=http
      - traefik.http.routers.fedservice-umu-http.middlewares=https-redirect
      - traefik.http.routers.fedservice-umu-https.rule=Host("umu.fedservice.lh")
      - traefik.http.routers.fedservice-umu-https.entrypoints=https
      - traefik.http.routers.fedservice-umu-https.tls=true
      - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.https-redirect.redirectscheme.permanent=true
      - traefik.http.services.fedservice-umu.loadbalancer.server.port=11833
    environment:
      - ENTITY_TYPE=intermediate
      - ENTITY_NAME=UMU
    ports:
      - 6002:11833
    volumes:
      - ./mkcertRootCA.crt:/usr/local/share/ca-certificates/mkcertRootCA.crt:ro
      - ./conf/intermediate/umu:/conf:ro
  swamid:
    image: ddgu/fedservice
    init: true
    hostname: swamid.fed2
    networks:
      - default
      - traefik
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.fedservice-swamid-http.rule=Host("swamid.fedservice.lh")
      - traefik.http.routers.fedservice-swamid-http.entrypoints=http
      - traefik.http.routers.fedservice-swamid-http.middlewares=https-redirect
      - traefik.http.routers.fedservice-swamid-https.rule=Host("swamid.fedservice.lh")
      - traefik.http.routers.fedservice-swamid-https.entrypoints=https
      - traefik.http.routers.fedservice-swamid-https.tls=true
      - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.https-redirect.redirectscheme.permanent=true
      - traefik.http.services.fedservice-swamid.loadbalancer.server.port=11833
    environment:
      - ENTITY_TYPE=ta
      - ENTITY_NAME=SWAMID
    ports:
      - 7002:11833
    volumes:
      - ./mkcertRootCA.crt:/usr/local/share/ca-certificates/mkcertRootCA.crt:ro
      - ./conf/ta/swamid:/conf:ro
  seid:
    image: ddgu/fedservice
    init: true
    hostname: seid.fed2
    networks:
      - default
      - traefik
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.fedservice-seid-http.rule=Host("seid.fedservice.lh")
      - traefik.http.routers.fedservice-seid-http.entrypoints=http
      - traefik.http.routers.fedservice-seid-http.middlewares=https-redirect
      - traefik.http.routers.fedservice-seid-https.rule=Host("seid.fedservice.lh")
      - traefik.http.routers.fedservice-seid-https.entrypoints=https
      - traefik.http.routers.fedservice-seid-https.tls=true
      - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.https-redirect.redirectscheme.permanent=true
      - traefik.http.services.fedservice-seid.loadbalancer.server.port=11833
    environment:
      - ENTITY_TYPE=ta
      - ENTITY_NAME=SEID
    ports:
      - 7001:11833
    volumes:
      - ./mkcertRootCA.crt:/usr/local/share/ca-certificates/mkcertRootCA.crt:ro
      - ./conf/ta/seid:/conf:ro
  auto:
    image: ddgu/fedservice
    init: true
    hostname: auto.fed2
    networks:
      - default
      - traefik
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.fedservice-auto-http.rule=Host("auto.fedservice.lh")
      - traefik.http.routers.fedservice-auto-http.entrypoints=http
      - traefik.http.routers.fedservice-auto-http.middlewares=https-redirect
      - traefik.http.routers.fedservice-auto-https.rule=Host("auto.fedservice.lh")
      - traefik.http.routers.fedservice-auto-https.entrypoints=https
      - traefik.http.routers.fedservice-auto-https.tls=true
      - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.https-redirect.redirectscheme.permanent=true
      - traefik.http.services.fedservice-auto.loadbalancer.server.port=11833
    environment:
      - ENTITY_TYPE=rp
      - ENTITY_NAME=AUTO
    ports:
      - 4002:11833
    volumes:
      - ./mkcertRootCA.crt:/usr/local/share/ca-certificates/mkcertRootCA.crt:ro
      - ./conf/rp/auto:/conf:ro
  expl:
    image: ddgu/fedservice
    init: true
    hostname: expl.fed2
    networks:
      - default
      - traefik
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.fedservice-expl-http.rule=Host("expl.fedservice.lh")
      - traefik.http.routers.fedservice-expl-http.entrypoints=http
      - traefik.http.routers.fedservice-expl-http.middlewares=https-redirect
      - traefik.http.routers.fedservice-expl-https.rule=Host("expl.fedservice.lh")
      - traefik.http.routers.fedservice-expl-https.entrypoints=https
      - traefik.http.routers.fedservice-expl-https.tls=true
      - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.https-redirect.redirectscheme.permanent=true
      - traefik.http.services.fedservice-expl.loadbalancer.server.port=11833
    environment:
      - ENTITY_TYPE=rp
      - ENTITY_NAME=EXPL
    ports:
      - 4001:11833
    volumes:
      - ./mkcertRootCA.crt:/usr/local/share/ca-certificates/mkcertRootCA.crt:ro
      - ./conf/rp/expl:/conf:ro
  op:
    image: ddgu/fedservice
    init: true
    hostname: op.fed2
    networks:
      - default
      - traefik
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.fedservice-op-http.rule=Host("op.fedservice.lh")
      - traefik.http.routers.fedservice-op-http.entrypoints=http
      - traefik.http.routers.fedservice-op-http.middlewares=https-redirect
      - traefik.http.routers.fedservice-op-https.rule=Host("op.fedservice.lh")
      - traefik.http.routers.fedservice-op-https.entrypoints=https
      - traefik.http.routers.fedservice-op-https.tls=true
      - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.https-redirect.redirectscheme.permanent=true
      - traefik.http.services.fedservice-op.loadbalancer.server.port=11833
    environment:
      - ENTITY_TYPE=op
      - ENTITY_NAME=OP
    ports:
      - 5000:11833
    volumes:
      - ./mkcertRootCA.crt:/usr/local/share/ca-certificates/mkcertRootCA.crt:ro
      - ./conf/op/op:/conf:ro

networks:
  default:
  traefik:
    external: true